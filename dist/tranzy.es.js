/**
 * Tranzy - 网页自动翻译插件
 * 支持自动检测DOM更新并翻译新增元素
 * 使用微软翻译API实现多语言翻译
 * 同时支持ESM和浏览器直接使用
 *
 * @author Tranzy
 * @license MIT
 */
const t=["script","style","noscript","code","pre","input","textarea",'[contenteditable="true"]',".tranzy-ignore"],e={toLang:navigator.language||"",fromLang:"",root:"body",ignore:[],force:[],doneClass:"tranzy-done",pendingClass:"tranzy-pending",auto:!1,batch:100,translator:null,manualDict:{},hooks:{before:null,after:null,beforeElement:null,afterElement:null}};function s(...t){return t.reduce(((t,e)=>(Object.keys(e).forEach((o=>{const i=t[o],r=e[o];Array.isArray(i)&&Array.isArray(r)?t[o]=Array.from(new Set([...i,...r])):n(i)&&n(r)?t[o]=s(i,r):t[o]=r})),t)),{})}function n(t){return t&&"object"==typeof t&&!Array.isArray(t)}class o{constructor(){this.dbName="tranzy-cache",this.storeName="translations",this.db=null,this.initPromise=this._initDatabase()}_generateHash(t){let e=2166136261;for(let s=0;s<t.length;s++)e^=t.charCodeAt(s),e*=16777619;return e.toString(36)}async _initDatabase(){return new Promise(((t,e)=>{const s=indexedDB.open(this.dbName,1);s.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains(this.storeName)||e.createObjectStore(this.storeName,{keyPath:"id"})},s.onsuccess=e=>{this.db=e.target.result,t()},s.onerror=t=>{e(t.target.error)}}))}async get(t,e,s=""){await this.initPromise;const n=this._generateHash(`${t}|${e}|${s}`);return new Promise((t=>{if(!this.db)return void t(null);const e=this.db.transaction(this.storeName,"readonly").objectStore(this.storeName).get(n);e.onsuccess=e=>{t(e.target.result?.value||null)},e.onerror=()=>{t(null)}}))}async set(t,e,s,n=""){await this.initPromise;const o=this._generateHash(`${t}|${s}|${n}`);return new Promise((t=>{if(!this.db)return void t();const s=this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).put({id:o,value:e});s.onsuccess=()=>{t()},s.onerror=()=>{t()}}))}async getBatch(t,e,s=""){await this.initPromise;const n=Array(t.length).fill(null),o=[];return await Promise.all(t.map((async(t,i)=>{const r=await this.get(t,e,s);r?n[i]=r:o.push(i)}))),{results:n,remainingIndices:o}}async setBatch(t,e,s,n=""){await this.initPromise,await Promise.all(t.map(((t,o)=>this.set(t,e[o],s,n))))}}class i{constructor(t=""){this.fromLang=t,this.tokenExpireMinutes=10,this._loadTokenFromSession()}_loadTokenFromSession(){try{const t=sessionStorage.getItem("tranzy_auth_token");if(t){const{token:e,timestamp:s}=JSON.parse(t),n=Date.now();e&&n-s<60*this.tokenExpireMinutes*1e3?(this.authToken=e,this.tokenTimestamp=s):this._clearTokenFromSession()}}catch(t){this._clearTokenFromSession()}}_saveTokenToSession(t,e){try{sessionStorage.setItem("tranzy_auth_token",JSON.stringify({token:t,timestamp:e}))}catch(t){}}_clearTokenFromSession(){try{sessionStorage.removeItem("tranzy_auth_token"),this.authToken=null,this.tokenTimestamp=0}catch(t){}}async getAuthToken(){const t=Date.now();if(this.authToken&&t-this.tokenTimestamp<60*this.tokenExpireMinutes*1e3)return this.authToken;try{const e=await fetch("https://edge.microsoft.com/translate/auth",{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`获取微软翻译授权失败: ${e.status} ${e.statusText}`);const s=await e.text();return this.tokenTimestamp=t,this.authToken=s,this._saveTokenToSession(s,t),s}catch(t){throw this._clearTokenFromSession(),t}}async translate(t,e){try{const s=t.filter((t=>t&&t.trim()));if(0===s.length)return[];const n=await this.getAuthToken(),o=`https://api.cognitive.microsofttranslator.com/translate?${this.fromLang?`from=${this.fromLang}&`:""}&to=${e}&api-version=3.0`,i=s.map((t=>({Text:t}))),r=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify(i)});if(!r.ok)throw new Error(`翻译请求失败: ${r.status} ${r.statusText}`);return(await r.json()).map((t=>t.translations[0].text))}catch(t){throw t}}}class r{constructor(t={}){this.config=s({},e,t),this.config.manualDict&&Object.keys(this.config.manualDict).forEach((t=>{const e=this.config.manualDict[t];Object.keys(e).forEach((t=>{"string"==typeof e[t]&&(e[t]={to:e[t],standalone:!0,case:!0})}))})),this.cache=new o,this.translator=this.config.translator||new i(this.config.fromLang),this.isTranslating=!1,this.pendingElements=new Set,this.observer=null,this.observerConfig={childList:!0,subtree:!0}}init(){return this.config.ignore=[...new Set([...t,...this.config.ignore||[]])],this.config.force=this.config.force||[],this.translatePage(),this.config.auto&&this.startObserver(),this}startObserver(){return this.observer&&this.observer.disconnect(),this.observer=new MutationObserver((t=>{let e=!1;for(const s of t)if("childList"===s.type&&s.addedNodes.length>0&&s.addedNodes.forEach((t=>{if(t.nodeType===Node.ELEMENT_NODE){const s=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,{acceptNode:function(t){return this.config.force.some((e=>t.matches(e)))?NodeFilter.FILTER_ACCEPT:this.config.ignore.some((e=>t.matches(e)))?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT}.bind(this)});if(this.config.ignore.some((e=>t.matches(e)))&&!this.config.force.some((e=>t.matches(e))))return;let n;for(this.pendingElements.add(t),e=!0;n=s.nextNode();)this.pendingElements.add(n)}})),"characterData"===s.type){const t=s.target.parentNode;if(t&&t.nodeType===Node.ELEMENT_NODE){let s=!1,n=t;for(;n;){if(this.config.ignore.some((t=>n.matches(t)))&&!this.config.force.some((t=>n.matches(t)))){s=!0;break}if(n=n.parentNode,!n||n===document)break}s||(this.pendingElements.add(t),e=!0)}}e&&this._translatePending()})),this.observer.observe(document.body,this.observerConfig),this}stopObserver(){return this.observer&&(this.observer.disconnect(),this.observer=null),this}async _translatePending(){if(0===this.pendingElements.size||this.isTranslating)return;this.isTranslating=!0;const t=Array.from(this.pendingElements);this.pendingElements.clear(),await this._translateElements(t),this.isTranslating=!1,this.pendingElements.size>0&&this._translatePending()}async translatePage(){if(this.isTranslating)return;this.isTranslating=!0;const t=!!this.observer;t&&this.stopObserver(),"function"==typeof this.config.hooks.before&&await this.config.hooks.before();try{const t=[],e=document.querySelector(this.config.root),s=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:function(t){return t.classList.contains(this.config.doneClass)?NodeFilter.FILTER_SKIP:t.matches(this.config.ignore)?this.config.force.some((e=>t.matches(e)))?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT:(this.config.force.some((e=>t.matches(e))),NodeFilter.FILTER_ACCEPT)}.bind(this)});let n;for(;n=s.nextNode();)t.push(n);await this._translateElements(t)}catch(t){}finally{"function"==typeof this.config.hooks.after&&await this.config.hooks.after(),this.isTranslating=!1,t&&this.startObserver()}return this}async _translateElements(t){const e=t.filter((t=>{if(t.classList.contains(this.config.doneClass))return!1;if(this.config.force.some((e=>t.matches(e))))return!0;let e=t.parentNode;for(;e&&e!==document;){if(e.matches(this.config.ignore))return!1;e=e.parentNode}if(t.matches(this.config.ignore))return!1;const s=this._getElementText(t);return s&&s.trim().length>0}));if(0===e.length)return;const s=this.config.batch;for(let t=0;t<e.length;t+=s){const n=e.slice(t,t+s);await this._translateElementBatch(n)}}_splitByTerms(t){const e=this.config.manualDict[this.config.toLang];if(!e)return[t];const s=Object.keys(e).sort(((t,e)=>e.length-t.length));for(const n of s){const s=e[n];if(!1!==s.standalone&&(!1===s.case?t.toLowerCase()===n.toLowerCase():t===n))return[t]}if(!s.some((s=>!1===e[s].case?t.toLowerCase().includes(s.toLowerCase()):t.includes(s))))return[t];const n=[];let o=t;for(;o.length>0;){let t=!1;for(const i of s){const s=e[i];if(!1!==s.standalone)continue;const r=!1===s.case?"gi":"g",a=new RegExp(`\\b${i}\\b`,r).exec(o);if(a){const e=a.index;e>0&&n.push(o.substring(0,e)),n.push(i),o=o.substring(e+i.length),t=!0;break}}if(!t){n.push(o);break}}return n}async _translateElementBatch(t){const e=[];let s=[];for(const n of t){if("function"==typeof this.config.hooks.beforeElement){if(!1===await this.config.hooks.beforeElement(n))continue}const t=this._getElementText(n);t&&t.trim().length>0&&this._shouldTranslateText(t)&&(e.push(n),s.push(t),n.classList.add(this.config.pendingClass))}if(0===s.length)return;const n={},o={},i=[],r=new Set;for(const t of s){const e=this._splitByTerms(t);if(1===e.length){const e=this.config.manualDict[this.config.toLang],s=e&&(e[t]||(!1===e[t.toLowerCase()]?.case?e[t.toLowerCase()]:null));s?n[t]=s.to:i.push(t)}else{o[t]=e;for(const t of e){const e=this.config.manualDict[this.config.toLang],s=e&&(e[t]||(!1===e[t.toLowerCase()]?.case?e[t.toLowerCase()]:null));if(s)n[t]=s.to;else{const e=await this.cache.get(t,this.config.toLang,this.config.fromLang);e?n[t]=e:r.add(t)}}}}const{results:a,remainingIndices:c}=await this.cache.getBatch(i,this.config.toLang,this.config.fromLang);let h=0;if(i.forEach((t=>{t in n||(n[t]=a[h++])})),c.forEach((t=>{r.add(i[t])})),r.size>0)try{const t=Array.from(r).filter((t=>this._shouldTranslateText(t)));if(Array.from(r).forEach((e=>{t.includes(e)||(n[e]=e)})),t.length>0){const e=await this.translator.translate(t,this.config.toLang);await this.cache.setBatch(t,e,this.config.toLang,this.config.fromLang);let s=0;t.forEach((t=>{n[t]=e[s++]}))}}catch(t){Array.from(r).forEach((t=>{n[t]=t}))}for(const[t,e]of Object.entries(o)){const s=e.map((t=>n[t]||t));n[t]=s.join("")}e.forEach(((t,e)=>{const o=s[e],i=n[o];i&&(t.classList.remove(this.config.pendingClass),this._applyTranslation(t,o,i),"function"==typeof this.config.hooks.afterElement&&this.config.hooks.afterElement(t,o,i))}))}_shouldTranslateText(t){return!(!t||/^\s*$/.test(t))&&!(/^[\s\d\p{P}\p{S}]+$/u.test(t)&&!/[\p{L}\u4e00-\u9fa5]/.test(t))}_getElementText(t){if("SCRIPT"===t.tagName||t.closest("script"))return null;let e="";const s=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:function(e){return"SCRIPT"===e.parentNode.tagName||e.parentNode.closest("script")?NodeFilter.FILTER_REJECT:e.parentNode!==t?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT}});let n;for(;n=s.nextNode();){const t=n.textContent.trim();t&&(e+=t+" ")}return e.trim()}_applyTranslation(t,e,s){if(s&&e!==s)if(t.classList.add(this.config.doneClass),t.childElementCount>0){const e=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:function(e){return e.parentNode!==t?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT}}),n=[];let o;for(;o=e.nextNode();)o.textContent.trim()&&n.push(o);if(1===n.length){const t=n[0].textContent.match(/^\s*/)[0],e=n[0].textContent.match(/\s*$/)[0];n[0].textContent=t+s+e}else if(n.length>1){for(let t=1;t<n.length;t++)n[t].textContent="";if(n[0]){const t=n[0].textContent.match(/^\s*/)[0],e=n[0].textContent.match(/\s*$/)[0];n[0].textContent=t+s+e}}}else{const e=t.textContent.match(/^\s*/)[0],n=t.textContent.match(/\s*$/)[0];t.textContent=e+s+n}}}export{r as default};
//# sourceMappingURL=tranzy.es.js.map
