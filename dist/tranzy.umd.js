!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Tranzy=e()}(this,(function(){"use strict";
/**
   * Tranzy - 网页自动翻译插件
   * 支持自动检测DOM更新并翻译新增元素
   * 使用微软翻译API实现多语言翻译
   * 同时支持ESM和浏览器直接使用
   *
   * @author Fts Cloud <ftsuperb@vip.qq.com>
   * @license MIT
   * @repository https://github.com/FtsCloud/Tranzy
   * @copyright Copyright (c) 2023-present Fts Cloud
   */const t=["style","script","noscript","code","pre","input","textarea",'[contenteditable="true"]',".tranzy-ignore"],e={toLang:navigator.language||"",fromLang:"",root:"body",ignore:[],force:[],doneClass:"tranzy-done",pendingClass:"tranzy-pending",auto:!1,batch:100,translator:null,manualDict:{},hooks:{before:null,after:null,beforeElement:null,afterElement:null}};function n(...t){return t.reduce(((t,e)=>(Object.keys(e).forEach((o=>{const i=t[o],r=e[o];Array.isArray(i)&&Array.isArray(r)?t[o]=Array.from(new Set([...i,...r])):s(i)&&s(r)?t[o]=n(i,r):t[o]=r})),t)),{})}function s(t){return t&&"object"==typeof t&&!Array.isArray(t)}class o{constructor(){this.dbName="tranzy-cache",this.storeName="translations",this.db=null,this.initPromise=this._initDatabase()}_generateHash(t){let e=2166136261;for(let n=0;n<t.length;n++)e^=t.charCodeAt(n),e*=16777619;return e.toString(36)}async _initDatabase(){return new Promise(((t,e)=>{const n=indexedDB.open(this.dbName,1);n.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains(this.storeName)||e.createObjectStore(this.storeName,{keyPath:"id"})},n.onsuccess=e=>{this.db=e.target.result,t()},n.onerror=t=>{e(t.target.error)}}))}async get(t,e,n=""){await this.initPromise;const s=this._generateHash(`${t}|${e}|${n}`);return new Promise((t=>{if(!this.db)return void t(null);const e=this.db.transaction(this.storeName,"readonly").objectStore(this.storeName).get(s);e.onsuccess=e=>{t(e.target.result?.value||null)},e.onerror=()=>{t(null)}}))}async set(t,e,n,s=""){await this.initPromise;const o=this._generateHash(`${t}|${n}|${s}`);return new Promise((t=>{if(!this.db)return void t();const n=this.db.transaction(this.storeName,"readwrite").objectStore(this.storeName).put({id:o,value:e});n.onsuccess=()=>{t()},n.onerror=()=>{t()}}))}async getBatch(t,e,n=""){await this.initPromise;const s=Array(t.length).fill(null),o=[];return await Promise.all(t.map((async(t,i)=>{const r=await this.get(t,e,n);r?s[i]=r:o.push(i)}))),{results:s,remainingIndices:o}}async setBatch(t,e,n,s=""){await this.initPromise,await Promise.all(t.map(((t,o)=>this.set(t,e[o],n,s))))}}class i{constructor(t=""){this.fromLang=t,this.tokenExpireMinutes=10,this._loadTokenFromSession()}_loadTokenFromSession(){try{const t=sessionStorage.getItem("tranzy_auth_token");if(t){const{token:e,timestamp:n}=JSON.parse(t),s=Date.now();e&&s-n<60*this.tokenExpireMinutes*1e3?(this.authToken=e,this.tokenTimestamp=n):this._clearTokenFromSession()}}catch(t){this._clearTokenFromSession()}}_saveTokenToSession(t,e){try{sessionStorage.setItem("tranzy_auth_token",JSON.stringify({token:t,timestamp:e}))}catch(t){}}_clearTokenFromSession(){try{sessionStorage.removeItem("tranzy_auth_token"),this.authToken=null,this.tokenTimestamp=0}catch(t){}}async getAuthToken(){const t=Date.now();if(this.authToken&&t-this.tokenTimestamp<60*this.tokenExpireMinutes*1e3)return this.authToken;try{const e=await fetch("https://edge.microsoft.com/translate/auth",{method:"GET",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`获取微软翻译授权失败: ${e.status} ${e.statusText}`);const n=await e.text();return this.tokenTimestamp=t,this.authToken=n,this._saveTokenToSession(n,t),n}catch(t){throw this._clearTokenFromSession(),t}}async translate(t,e){try{const n=t.filter((t=>t&&t.trim()));if(0===n.length)return[];const s=await this.getAuthToken(),o=`https://api.cognitive.microsofttranslator.com/translate?${this.fromLang?`from=${this.fromLang}&`:""}to=${e}&api-version=3.0`,i=n.map((t=>({Text:t}))),r=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify(i)});if(!r.ok)throw new Error(`翻译请求失败: ${r.status} ${r.statusText}`);return(await r.json()).map((t=>t.translations[0].text))}catch(t){throw t}}}return class{constructor(t={}){this.config=n({},e,t),this.config.manualDict&&Object.keys(this.config.manualDict).forEach((t=>{const e=this.config.manualDict[t];Object.keys(e).forEach((t=>{"string"==typeof e[t]&&(e[t]={to:e[t],standalone:!0,case:!0})}))})),this.cache=new o,this.translator=this.config.translator||new i(this.config.fromLang),this.isTranslating=!1,this.pendingElements=new Set,this.observer=null,this.observerConfig={childList:!0,subtree:!0},this.forceSelectorString="",this.ignoreSelectorString=""}_createNodeFilter(){return{acceptNode:function(t){if(t.classList.contains(this.config.doneClass))return NodeFilter.FILTER_SKIP;if(this.forceSelectorString&&t.matches(this.forceSelectorString))return NodeFilter.FILTER_ACCEPT;if(this.forceSelectorString){let e=t.parentNode;for(;e&&e!==document;){if(e.matches(this.forceSelectorString))return NodeFilter.FILTER_ACCEPT;e=e.parentNode}}if(this.forceSelectorString&&t.children.length>0){if(t.querySelector(this.forceSelectorString))return NodeFilter.FILTER_SKIP}if(this.ignoreSelectorString&&t.matches(this.ignoreSelectorString))return NodeFilter.FILTER_REJECT;if(this.ignoreSelectorString){let e=t.parentNode;for(;e&&e!==document;){if(e.matches(this.ignoreSelectorString))return NodeFilter.FILTER_REJECT;e=e.parentNode}}return NodeFilter.FILTER_ACCEPT}.bind(this)}}translate(){return this.config.ignore=[...new Set([...t,...this.config.ignore||[]])],this.config.force=this.config.force||[],this.forceSelectorString=this.config.force.length?this.config.force.join(","):"",this.ignoreSelectorString=this.config.ignore.length?this.config.ignore.join(","):"",this.translatePage(),this.config.auto&&this.startObserver(),this}startObserver(){return this.observer&&this.observer.disconnect(),this.observer=new MutationObserver((t=>{let e=!1;for(const n of t)if("childList"===n.type&&n.addedNodes.length>0&&n.addedNodes.forEach((t=>{if(t.nodeType===Node.ELEMENT_NODE){const n=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,this._createNodeFilter());let s;for(this.pendingElements.add(t),e=!0;s=n.nextNode();)this.pendingElements.add(s)}})),"characterData"===n.type){const t=n.target.parentNode;if(t&&t.nodeType===Node.ELEMENT_NODE){let n=!1,s=t;for(;s;){if(this.ignoreSelectorString&&s.matches(this.ignoreSelectorString)&&(!this.forceSelectorString||!s.matches(this.forceSelectorString))){n=!0;break}if(s=s.parentNode,!s||s===document)break}n||(this.pendingElements.add(t),e=!0)}}e&&this._translatePending()})),this.observer.observe(document.body,this.observerConfig),this}stopObserver(){return this.observer&&(this.observer.disconnect(),this.observer=null),this}async _translatePending(){if(0===this.pendingElements.size||this.isTranslating)return;this.isTranslating=!0;const t=Array.from(this.pendingElements);this.pendingElements.clear(),await this._translateElements(t),this.isTranslating=!1,this.pendingElements.size>0&&this._translatePending()}async translatePage(){if(this.isTranslating)return;this.isTranslating=!0;const t=!!this.observer;t&&this.stopObserver(),"function"==typeof this.config.hooks.before&&await this.config.hooks.before();try{const t=[],e=document.querySelector(this.config.root),n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,this._createNodeFilter());let s;for(;s=n.nextNode();)t.push(s);await this._translateElements(t)}catch(t){}finally{"function"==typeof this.config.hooks.after&&await this.config.hooks.after(),this.isTranslating=!1,t&&this.startObserver()}return this}async _translateElements(t){const e=[],n=[];for(const s of t){const t=this._getElementText(s);t&&(e.push(s),n.push(t))}if(0===e.length)return;const s=this.config.batch;for(let t=0;t<e.length;t+=s){const o=e.slice(t,t+s),i=n.slice(t,t+s);await this._translateElementBatch(o,i)}}_splitByTerms(t){const e=this.config.manualDict[this.config.toLang];if(!e)return[t];const n=Object.keys(e).sort(((t,e)=>e.length-t.length));for(const s of n){const n=e[s];if(!1!==n.standalone&&(!1===n.case?t.toLowerCase()===s.toLowerCase():t===s))return[t]}let s=!1;for(const o of n){if(!1===e[o].case?t.toLowerCase().includes(o.toLowerCase()):t.includes(o)){s=!0;break}}if(!s)return[t];const o=[];let i=t;for(;i.length>0;){let t=!1;for(const s of n){const n=e[s];if(!1!==n.standalone)continue;const r=!1===n.case?"gi":"g",a=new RegExp(`\\b${s}\\b`,r).exec(i);if(a){const e=a.index;e>0&&o.push(i.substring(0,e)),o.push(s),i=i.substring(e+s.length),t=!0;break}}if(!t){o.push(i);break}}return o}async _translateElementBatch(t,e){const n=[];let s=[];for(let o=0;o<t.length;o++){const i=t[o],r=e[o];if("function"==typeof this.config.hooks.beforeElement){if(!1===await this.config.hooks.beforeElement(i))continue}n.push(i),s.push(r),i.classList.add(this.config.pendingClass)}if(0===s.length)return;const o=new Map;for(let t=0;t<n.length;t++){const e=n[t];if(e.childElementCount>0){const i=[],r=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:function(t){return t.parentNode!==e?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT}});let a;for(;a=r.nextNode();){const t=a.textContent,e=t.trim();e&&i.push({node:a,text:e,leadingSpaces:t.match(/^\s*/)[0],trailingSpaces:t.match(/\s*$/)[0]})}i.length>1&&(o.set(e,i),i.forEach((t=>{s.push(t.text),n.push({isTextNode:!0,nodeInfo:t})})),s[t]=null)}}const i=n.filter(((t,e)=>null!==s[e])),r=s.filter((t=>null!==t)),a=[],c=new Map;for(const t of r){if(!t)continue;const e=this._splitByTerms(t);e.length>1?(c.set(t,e),e.forEach((t=>a.push(t)))):a.push(t)}const h=[...new Set(a)],l={},f=[];for(const t of h){const e=this.config.manualDict[this.config.toLang],n=e&&(e[t]||(!1===e[t.toLowerCase()]?.case?e[t.toLowerCase()]:null));if(n)l[t]=n.to;else{const e=await this.cache.get(t,this.config.toLang,this.config.fromLang);e?l[t]=e:f.push(t)}}if(f.length>0)try{const t=await this.translator.translate(f,this.config.toLang);await this.cache.setBatch(f,t,this.config.toLang,this.config.fromLang),f.forEach(((e,n)=>{l[e]=t[n]}))}catch(t){f.forEach((t=>{l[t]=t}))}const g=new Map;for(const[t,e]of c.entries()){const n=e.map((t=>l[t]||t));g.set(t,n.join(""))}for(const t of r)t&&!c.has(t)&&g.set(t,l[t]||t);i.forEach(((t,e)=>{const n=r[e];if(!n)return;const s=g.get(n);if(s)if(t.isTextNode){const{node:e,leadingSpaces:o,trailingSpaces:i}=t.nodeInfo;e.textContent=o+s+i;const r=e.parentNode;r&&(r.classList.remove(this.config.pendingClass),r.classList.add(this.config.doneClass),"function"==typeof this.config.hooks.afterElement&&this.config.hooks.afterElement(r,n,s))}else t.classList.remove(this.config.pendingClass),o.has(t)?t.classList.add(this.config.doneClass):this._applyTranslation(t,n,s),"function"==typeof this.config.hooks.afterElement&&this.config.hooks.afterElement(t,n,s)}))}_getElementText(t){let e="";const n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:function(e){return e.parentNode!==t?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT}});let s;for(;s=n.nextNode();){const t=s.textContent.trim();t&&(e+=t+" ")}return e=e.trim(),!e||/^\s*$/.test(e)||/^[\s\d\p{P}\p{S}]+$/u.test(e)&&!/[\p{L}\u4e00-\u9fa5]/.test(e)?null:e}_applyTranslation(t,e,n){if(n&&e!==n)if(t.classList.add(this.config.doneClass),t.childElementCount>0){const e=[],s=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:function(e){return e.parentNode!==t?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT}});let o;for(;o=s.nextNode();){const t=o.textContent,n=t.trim();n&&e.push({node:o,text:n,leadingSpaces:t.match(/^\s*/)[0],trailingSpaces:t.match(/\s*$/)[0]})}if(0===e.length)return;if(1===e.length){const{node:t,leadingSpaces:s,trailingSpaces:o}=e[0];return void(t.textContent=s+n+o)}const i=e.reduce(((t,e)=>t+e.text.length),0);let r=0;e.forEach(((t,s)=>{const{node:o,text:a,leadingSpaces:c,trailingSpaces:h}=t;let l;if(s===e.length-1)l=n.substring(r);else{const t=a.length/i,e=Math.round(n.length*t);l=n.substring(r,r+e),r+=e}o.textContent=c+l+h}))}else{const e=t.textContent.match(/^\s*/)[0],s=t.textContent.match(/\s*$/)[0];t.textContent=e+n+s}}destroy(){return this.stopObserver(),this.pendingElements.clear(),this.cache&&this.cache.db&&(this.cache.db.close(),this.cache.db=null),this.isTranslating=!1,this}}}));
//# sourceMappingURL=tranzy.umd.js.map
